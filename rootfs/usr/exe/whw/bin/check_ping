#!/bin/sh
  /usr/exe/whw/bin/check_current_channel

 start_time=$( date +%s);
 time_connection=0;
 period_connection=30;
       
  a='';
  if [ $WORK_ROLE ]; then
	if [ x"$WORK_ROLE" == x"Controller" ]; then
		is_extender=0;
	else
		is_extender=1;
	fi
  else
	is_extender=`cfgcli -g InternetGatewayDevice.X_ALU-COM_Wifi.WorkRole | awk -F "=" '{if($2=="Controller") print 0; else print 1;}'`;
  fi

  until [ "$a" == "1" ] ||  [ $time_connection -gt $period_connection ]; do
    gateway="";
    if [ -e /etc/net.conf -a "$is_extender" == "1" ]; then
      gateway=`cat /etc/net.conf | grep gateway  | awk -F "=" '{print $2}'`;
    fi
    if [ -z "${gateway// }" ]; then
      gateway=`ifconfig br0 | grep "inet addr" | awk -F " " '{print $2}' | awk -F ":" '{print $2}'`;
   fi

    time_connection=$( date +%s);
    time_connection=$((time_connection - start_time)); 
   
    if [ ! -z "${gateway// }" ]; then
     a=`ping $gateway -c 2 -W 5 | grep "packet loss" | awk -F ", " '{print $3}' | awk -F " " '{gsub("%","",$1); if(($1+0.1)<100) print 1; else print 0;}'`; 
    fi
    usleep 1500;
  done;

  if [ $time_connection -gt $period_connection ]; then
    echo 2;
  else
    echo 1;
    rm /tmp/wds_processing 2>/dev/null #backhaul is recovered, re-enable background-scan on B1
  fi


